<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Double Pendulum Plot</title>

    <link rel="stylesheet" type="text/css" href="style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js" integrity="sha512-nNOFtIS+H0lwgdUDaPn/g1ssw3uN9AkEM7zy2wLaTQeLQNeNiitUcLpEpDIh3Z4T22MdeTNru/SQbNM4ig2rng==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js" integrity="sha512-3piO8GKVGn3D+eEWnTquDnlxM00ESMZpYNAnjmOMswHrGihZvdlsRjSW1bHLqahzIoyL9YWlLWVYRV4J8AHwtg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="libraries/p5.min.js"></script>
    <script src="libraries/p5.sound.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5.capture@1.6.0/dist/p5.capture.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
  </head>

  <body>
    <h1>Double pendulum plot!</h1>
    <strong><p>Scroll down fully to view the simulation</p>
    <p>You may have to wait a bit for the pendulums to diverge before the lines start appearing</p>
    <p>Open DevTools (f12) to view time taken for each frame (miliseconds). Each frame will print one line.</p>
    <p>Press S to save<p>
    <p><strong>Double click to view the pendulum in a new tab</strong></p>
    </strong>
    <h2>Please scroll down a bit and enable RK4 then click "update parameters"</h2>
    <h2>Also, switching tabs may cause the simulation to show random stuff with DeltaTime</h2>
    
    <button onclick="window.scrollTo(0, document.body.scrollHeight);">Scroll to simulation</button>
    <script src="sketch.js"></script>
    <p>Source code:</p> 
    <a href="https://github.com/itzmetanjim/double-pendulum">https://github.com/itzmetanjim/double-pendulum</a>
    <p>You can find many extra screenshots and images there.</p>
    <p>Presets:</p>
    
    <p><a href="/double-pendulum/?canvasSize=600&damp=0.999&type=avg%2Cavg%2Cavg%2Cfull&rk4=true&timeStep=1&g=10&l1=100&l2=100&m1=10&m2=10&a1_v=0&a2_v=0&space=angle&init_a1=1.57&init_a2=1.57"><button>Recommended, 600px RK4</button></a>
    <a href="/double-pendulum/?canvasSize=300&damp=0.999&type=avg%2Cavg%2Cavg%2Cfull&rk4=true&timeStep=1&g=10&l1=100&l2=100&m1=10&m2=10&a1_v=0&a2_v=0&space=angle&init_a1=1.57&init_a2=1.57"><button>Recommended Fast, 300px RK4</button></a>
    <a href="/double-pendulum/?canvasSize=100&damp=0.999&type=avg%2Cavg%2Cavg%2Cfull&rk4=true&timeStep=1&g=10&l1=100&l2=100&m1=10&m2=10&a1_v=0&a2_v=0&space=angle&init_a1=1.57&init_a2=1.57"><button>Ultrafast 100px RK4</button></a>
    <a href="/double-pendulum/?canvasSize=800&damp=0.999&type=avg%2Cavg%2Cavg%2Cfull&rk4=true&timeStep=1&g=10&l1=100&l2=100&m1=10&m2=10&a1_v=0&a2_v=0&space=angle&init_a1=1.57&init_a2=1.57"><button>High-res 800px RK4</button></a></p>
    <a href="/double-pendulum/?canvasSize=1000&damp=0.999&type=avg%2Cavg%2Cavg%2Cfull&rk4=true&timeStep=1&g=10&l1=100&l2=100&m1=10&m2=10&a1_v=0&a2_v=0&space=angle&init_a1=1.57&init_a2=1.57"><button>Higher res 1000px RK4</button></a></p>
    You should go with 600 or 300px. Note that reducing the resolution will increase the speed in n^2 rate.<br>
    This means 300px is 4x faster than 600px, and 100px is 36x faster than 600px.<br>
    <p>Parameters:</p>
    <p>Canvas size in pixels: <input type="text" id="csize" placeholder="600"></input></p>
    <p class="subtle">Reduce to make plot faster. If you enabled deltaTime, reducing this will make it more accurate (for the plotted values)</p>
    <p>Damping factor:<input type="text" id="damp" placeholder="1"></input></p>
    <p class="subtle">0 to 1, example: 0.999. The velocities get multiplied by this every tick</p>
    <p>DeltaTime enabled? <input type="text" id="deltaTime" placeholder="no"></input></p>
    <p class="subtle">If true, the simulation will use deltatime. This may make the viewing experience better, but it also may make it less accurate for laggier PCs.</p>
    <p>Time step: <input type="text" id="timeStep" placeholder="1"></input></p>
    <p class="subtle">The time step. If deltaTime is enabled it will be multiplied by deltatime.</p>
    <p>Use RK4: <input type="text" id="rk4" placeholder="false"></input></p>
    <p class="subtle">If true, this will use a more accurate 4th order Runge Kutta simulation (RK4).</p>
    <p class="subtle">If false, it will use the simpler and faster but less accurate Euler simulation.</p>
    <p class="subtle">RK4 is way slower than Eulerian, but it is more accurate.There are minor differences between the outputs, especially in the top-right and bottom-left corners.</p>
    <p class="subtle">DeltaTime may make RK4 less accurate than Eulerian if enabled.</p>
    <p class="subtle"><strong>It's recommended to try RK4 first.</strong></p>

    <h3>Physical Parameters:</h3>
    <p>Gravity (g): <input type="text" id="g" placeholder="10"></input></p>
    <p class="subtle">Gravitational acceleration. Default: 10</p>
    <p>Length 1 (l1): <input type="text" id="l1" placeholder="100"></input></p>
    <p class="subtle">Length of the top pendulum arm. Default: 100</p>
    <p>Length 2 (l2): <input type="text" id="l2" placeholder="100"></input></p>
    <p class="subtle">Length of the bottom pendulum arm. Default: 100</p>
    <p>Mass 1 (m1): <input type="text" id="m1" placeholder="10"></input></p>
    <p class="subtle">Mass of the top pendulum bob. Default: 10</p>
    <p>Mass 2 (m2): <input type="text" id="m2" placeholder="10"></input></p>
    <p class="subtle">Mass of the bottom pendulum bob. Default: 10</p>
    <p>Initial Angular Velocity 1 (a1_v): <input type="text" id="a1_v" placeholder="0"></input></p>
    <p class="subtle">Initial angular velocity of the top pendulum. Default: 0</p>
    <p>Initial Angular Velocity 2 (a2_v): <input type="text" id="a2_v" placeholder="0"></input></p>
    <p class="subtle">Initial angular velocity of the bottom pendulum. Default: 0</p>

    <h3>Parameter Space:</h3>
    <p>Space Type: <input type="text" id="space" placeholder="angle"></input></p>
    <p class="subtle">What parameter to vary across the plot. Options: angle, velocity, momentum, mass, length. Default: angle</p>
    <p>Initial Angle 1 (for non-angle spaces): <input type="text" id="init_a1" placeholder="1.57"></input></p>
    <p class="subtle">Initial angle for the top pendulum when not in angle-space. Default: π/2 (1.57)</p>
    <p>Initial Angle 2 (for non-angle spaces): <input type="text" id="init_a2" placeholder="1.57"></input></p>
    <p class="subtle">Initial angle for the bottom pendulum when not in angle-space. Default: π/2 (1.57)</p>
    <p>Scale Min: <input type="text" id="scale_min" placeholder="-3.14159"></input></p>
    <p class="subtle">Minimum value for the parameter space. Default: -π for angle, appropriate values for other spaces</p>
    <p>Scale Max: <input type="text" id="scale_max" placeholder="3.14159"></input></p>
    <p class="subtle">Maximum value for the parameter space. Default: π for angle, appropriate values for other spaces</p>

    <p>Color channel types (red, green, blue, alpha): <input type="text" id="ctype" placeholder="avg,avg,avg,full"></input></p>
    <p class="subtle">Use to modify the plot variables</p>
    <p class="subtle">Color channel types can be specified to generate custom plots</p>
    <button onclick="window.scrollTo(0, document.body.scrollHeight);">Scroll to simulation</button>&nbsp; 
     <button onclick="updateParameters()">Update Parameters</button>
    <p>After (a lot of) some time, the result should approach something like this:</p>
    <a href="example.png" target="_blank">Click here for image</a>
    <p>You will see that most stable pendulums are in this big region near the center as well as smaller "islands of stability" near it that are disjoint from the main one</p>
    <p>For a video explaining what this is (along with more interesting stuff and more graphs), check this out:</p>
    <a href="https://www.youtube.com/watch?v=dtjb2OhEQcU">Video link</a>
    <h2>Color channel string info</h2>
    <p>The color channel types string should be in the format: <code>[red],[green],[blue],[alpha]</code></p>
    <p>where <code>[red],[green],[blue],[alpha]</code> are in:</p>
    <ul>
      <li><code>avg</code>: Average of top angle divergence and bottom angle divergence</li>
      <li><code>a1</code>: Top angle divergence</li>
      <li><code>a2</code>: Bottom angle divergence</li>
      <li><code>angle1</code> The value of the first angle, scaled to 255. This is not the divergence.</li>
      <li><code>angle2</code> The value of the second angle, scaled to 255. This is not the divergence.</li>
      <li><code>max</code>: Maximum of top angle divergence and bottom angle divergence</li>
      <li><code>min</code>: Minimum of top angle divergence and bottom angle divergence</li>
      <li><code>zero</code>: Channel value set to 0</li>
      <li><code>full</code>: Channel value set to 255</li>
      <li><code>[number]</code>: Any constant integer value between 0 and 255</li>
    </ul>
    <p>You can also specify the first element to be <code>hsv</code>. <br>
      In that case the subsequent elements will be interpreted as hue(0-360),saturation(0-100) and value/brightness(0-100). The scaling will happen in the same way.</p>
    <h2>Parameter Space Info</h2>
    <p>The <strong>Space Type</strong> parameter determines what varies across the plot:</p>
    <ul>
      <li><code>angle</code>: (Default) Horizontal = initial angle 1 (a1), Vertical = initial angle 2 (a2). Default scale: -π to π</li>
      <li><code>velocity</code> or <code>momentum</code>: Horizontal = initial velocity 1 (a1_v), Vertical = initial velocity 2 (a2_v). Default scale: -10 to 10. Set initial angles with init_a1 and init_a2.</li>
      <li><code>mass</code>: Horizontal = mass 1 (m1), Vertical = mass 2 (m2). Default scale: 1 to 100. Set initial angles with init_a1 and init_a2.</li>
      <li><code>length</code>: Horizontal = length 1 (l1), Vertical = length 2 (l2). Default scale: 10 to 200. Set initial angles with init_a1 and init_a2.</li>
    </ul>
    <p>Use <strong>Scale Min</strong> and <strong>Scale Max</strong> to customize the range for any space type.</p>
    <button onclick="updateParameters()">Update Parameters</button> <br>
    <button onclick="window.scrollTo(0, document.body.scrollHeight);">Scroll to simulation</button>
    <p>Periodic save period, 0 or "disable" to disable. This does not reload the window. <input type="text" placeholder="seconds" id="savep"></input><button onclick="savePeriodUpdate()">Update save period</button></p>
    <button onclick="window.saveSketch()">Save Now</button>
    <br>
    <br>
    <p>You may have to wait a bit for the pendulums to diverge before the lines start appearing</p>
    Press S to save<br>
    <strong>Double click to view the pendulum in a new tab</strong><br>
    Open DevTools (f12) to view time taken for each frame (miliseconds). Each frame will print one line.<br>
    <button onclick="window.scrollTo(0, document.body.scrollHeight);">Scroll to simulation</button> <button onclick="document.getElementById('benchmark').classList.toggle('displaynone')">Toggle FPS graph</button>
    <div id="benchmark">
        <canvas id="fpsChart" width="400" height="200"></canvas>
    </div>

    <p><strong>Plot</strong></p>
    <span class="small">FPS: <span id="fps">...</span>, recording:use the recording widget that popped up,  these buttons may also work <button id="startButton" onclick="startRecord()">start</button> <button id="stopButton" onclick="stopRecord()" disabled>stop and save</button></span>
    <script>
      let csize_in = document.getElementById("csize");
      let damp_in = document.getElementById("damp");
      let ctype_in = document.getElementById("ctype");
      let deltaTime_in = document.getElementById("deltaTime");
      let timeStep_in = document.getElementById("timeStep");
      let rk4_in = document.getElementById("rk4");
      let g_in = document.getElementById("g");
      let l1_in = document.getElementById("l1");
      let l2_in = document.getElementById("l2");
      let m1_in = document.getElementById("m1");
      let m2_in = document.getElementById("m2");
      let a1_v_in = document.getElementById("a1_v");
      let a2_v_in = document.getElementById("a2_v");
      let space_in = document.getElementById("space");
      let init_a1_in = document.getElementById("init_a1");
      let init_a2_in = document.getElementById("init_a2");
      let scale_min_in = document.getElementById("scale_min");
      let scale_max_in = document.getElementById("scale_max");
      
      window.saveSketch=save;
      window.prevms=Date.now()
      window.savePeriod=0

      rk4_in.value = new URL(window.location.href).searchParams.get('rk4') || "";
      deltaTime_in.value = new URL(window.location.href).searchParams.get('deltaTime')
      timeStep_in.value = new URL(window.location.href).searchParams.get('timeStep') || "1";
      csize_in.value = new URL(window.location.href).searchParams.get('canvasSize') || "600";
      damp_in.value = new URL(window.location.href).searchParams.get('damp') || "0.999";
      ctype_in.value = new URL(window.location.href).searchParams.get('type') || "avg,avg,avg,full";
      g_in.value = new URL(window.location.href).searchParams.get('g') || "10";
      l1_in.value = new URL(window.location.href).searchParams.get('l1') || "100";
      l2_in.value = new URL(window.location.href).searchParams.get('l2') || "100";
      m1_in.value = new URL(window.location.href).searchParams.get('m1') || "10";
      m2_in.value = new URL(window.location.href).searchParams.get('m2') || "10";
      a1_v_in.value = new URL(window.location.href).searchParams.get('a1_v') || "0";
      a2_v_in.value = new URL(window.location.href).searchParams.get('a2_v') || "0";
      space_in.value = new URL(window.location.href).searchParams.get('space') || "angle";
      init_a1_in.value = new URL(window.location.href).searchParams.get('init_a1') || "1.57";
      init_a2_in.value = new URL(window.location.href).searchParams.get('init_a2') || "1.57";
      scale_min_in.value = new URL(window.location.href).searchParams.get('scale_min') || "";
      scale_max_in.value = new URL(window.location.href).searchParams.get('scale_max') || "";
      
      function updateParameters() {
        const csize = document.getElementById("csize").value;
        const damp = document.getElementById("damp").value;
        const ctype = document.getElementById("ctype").value;
        const deltaTime = document.getElementById("deltaTime").value;
        const timeStep = document.getElementById("timeStep").value;
        const rk4 = document.getElementById("rk4").value;
        const g = document.getElementById("g").value;
        const l1 = document.getElementById("l1").value;
        const l2 = document.getElementById("l2").value;
        const m1 = document.getElementById("m1").value;
        const m2 = document.getElementById("m2").value;
        const a1_v = document.getElementById("a1_v").value;
        const a2_v = document.getElementById("a2_v").value;
        const space = document.getElementById("space").value;
        const init_a1 = document.getElementById("init_a1").value;
        const init_a2 = document.getElementById("init_a2").value;
        const scale_min = document.getElementById("scale_min").value;
        const scale_max = document.getElementById("scale_max").value;

        var url = new URL(window.location.href);
        url.searchParams.set('canvasSize', csize);
        url.searchParams.set('damp', damp);
        url.searchParams.set('type', ctype);
        if (deltaTime.toLowerCase() === "yes" || deltaTime.toLowerCase() === "true") {
          url.searchParams.set('deltaTime', 'true');
        } //else set it to nothing
        if (rk4.toLowerCase() === "yes" || rk4.toLowerCase() === "true") {
          url.searchParams.set('rk4', 'true');
        } 
        if (timeStep !== "") {
          url.searchParams.set('timeStep', timeStep);
        }
        if (g !== "") {
          url.searchParams.set('g', g);
        }
        if (l1 !== "") {
          url.searchParams.set('l1', l1);
        }
        if (l2 !== "") {
          url.searchParams.set('l2', l2);
        }
        if (m1 !== "") {
          url.searchParams.set('m1', m1);
        }
        if (m2 !== "") {
          url.searchParams.set('m2', m2);
        }
        if (a1_v !== "") {
          url.searchParams.set('a1_v', a1_v);
        }
        if (a2_v !== "") {
          url.searchParams.set('a2_v', a2_v);
        }
        if (space !== "") {
          url.searchParams.set('space', space);
        }
        if (init_a1 !== "") {
          url.searchParams.set('init_a1', init_a1);
        }
        if (init_a2 !== "") {
          url.searchParams.set('init_a2', init_a2);
        }
        if (scale_min !== "") {
          url.searchParams.set('scale_min', scale_min);
        }
        if (scale_max !== "") {
          url.searchParams.set('scale_max', scale_max);
        }
        //redirect!
        window.location.href = url.href;
      }
      const ctx = document.getElementById('fpsChart').getContext('2d');
      const fpsData = {
        labels: [],
        datasets: [{
          label: 'fps',
          data: [],
          borderColor: 'rgb(79, 195, 247)',
          backgroundColor: 'rgba(79, 195, 247, 0.1)',
          borderWidth: 2,
          tension: 0.4,
          pointRadius: 0
        }]
      };
      const fpsChart = new Chart(ctx, {
        type: 'line',
        data: fpsData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: true,
          scales: {
            x: {
                 display: false,
            },
            y: {
              beginAtZero: true,
//              max: 5,
              grid: {
                color: '#3c3c3c'
              },
              ticks: {
                color: '#d4d4d4'
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: '#d4d4d4'
              }
            }
          }
        }
      });
      function updateFPS(fps) {
        const currentFPS = window.cfDeltaTime ? 1000/window.cfDeltaTime : 0
        document.getElementById("fps").innerText = currentFPS.toFixed(1)
        fpsData.labels.push('')
        fpsData.datasets[0].data.push(currentFPS)/*
        if (fpsData.labels.length > 60) {
          fpsData.labels.shift()
          fpsData.datasets[0].data.shift()
        }*/
        fpsChart.update()
      }
      setInterval(updateFPS,100)
      function savePeriodUpdate() {
        const sp = document.getElementById("savep").value;
        if (sp.toLowerCase() === "disable" || sp === "0" || sp === "") {
          window.savePeriod = 0;
        } else {
          const spnum = parseFloat(sp);
          if (!isNaN(spnum) && spnum > 0) {
            window.savePeriod = spnum;
          } else {
            window.savePeriod=0;
          }
        }
      }
      function saveF(){
        const nowms = Date.now();
        if (window.savePeriod > 0 && nowms - window.prevms >= window.savePeriod * 1000) {
          window.prevms = nowms;
          window.saveSketch();
        }
      }
      setInterval(saveF, 10);
      window.isRecording = false;
      function addtheframe(){
        if (window.isRecording) {
          window.gif.addFrame(document.querySelector('canvas').getContext('2d'), {copy: true, delay: window.timems});
        }
      }function startRecord() {
        let timems=eval(prompt("miliseconds per frame? (you can use JS expressions like 1000/30 for 30fps, blank for 1000/30)","1000/30"));
        window.timems=timems;
        if (!window.isRecording) {
          window.isRecording = true;
          document.getElementById("startButton").disabled = true;
          document.getElementById("stopButton").disabled = false;
          window.gif = new GIF({
            workers: 2,
            quality: 10,
            workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
          });

        window.iid = setInterval(addtheframe, 10);
        }
      }
      
      function stopRecord() {
        if (window.isRecording) {
          window.isRecording = false;
          document.getElementById("startButton").disabled = false;
          document.getElementById("stopButton").disabled = true;
          window.gif.on('finished', function(blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sim.gif';
            a.innerHTML=`
            <button>Download your recording!</button>
            `;
            document.body.appendChild(a);
            a.click();
          })
          clearInterval(window.iid);
          window.gif.render();
        }
    }
    </script>

  </body>
</html>
